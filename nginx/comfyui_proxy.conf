# ComfyUI队列代理配置
#
# 此配置需要添加到主Nginx配置文件的 server 块中
#
# 使用方法：
# 1. 将此文件内容复制到nginx主配置文件的server块中
# 2. 或者使用 include 指令: include /path/to/comfyui_proxy.conf;
#
# 注意：需要Nginx安装了 ngx_http_sub_filter_module 模块
# 检查：nginx -V 2>&1 | grep ngx_http_sub_filter_module

# ==================== ComfyUI反向代理配置 ====================

# ComfyUI代理路由 - 从URL中提取用户名和端口
# URL格式: /comfyui/{username}/{port}
location ~ ^/comfyui/([^/]+)/(\d+)(.*)$ {
    # 提取端口变量
    set $comfy_username $1;
    set $comfy_port $2;
    set $comfy_path $3;

    # 代理到GPU服务器ComfyUI实例
    proxy_pass http://192.168.150.2:$comfy_port$comfy_path;

    # 基本代理头设置
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # WebSocket支持（ComfyUI使用WebSocket进行实时通信）
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    # 超时设置（ComfyUI工作流可能执行较长时间）
    proxy_connect_timeout 600s;
    proxy_send_timeout 600s;
    proxy_read_timeout 600s;

    # 缓冲设置
    proxy_buffering off;
    proxy_request_buffering off;

    # 注入队列脚本到ComfyUI页面
    # 在</head>前注入我们的排队脚本
    sub_filter '</head>'
        '<script src="/static/js/comfyui-queue.js"></script>'
        '<script>window.COMFY_PROXY_BASE_URL="";</script></head>';

    sub_filter_once on;
    sub_filter_types text/html;
    sub_filter_last_modified on;

    # 处理跨域请求（ComfyUI API）
    add_header Access-Control-Allow-Origin *;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
    add_header Access-Control-Allow-Headers "Content-Type, Authorization";

    # 处理OPTIONS预检请求
    if ($request_method = OPTIONS) {
        return 204;
    }
}

# ComfyUI静态资源代理（可选，用于缓存）
location ~ ^/comfyui/([^/]+)/(\d+)/static/(.*)$ {
    set $comfy_port $2;
    set $static_path $3;

    proxy_pass http://192.168.150.2:$comfy_port/static/$static_path;
    proxy_set_header Host $http_host;

    # 静态资源缓存
    expires 7d;
    add_header Cache-Control "public, immutable";
}

# ComfyUI API请求代理（/prompt, /queue, /history等）
# 这些请求会被注入的脚本拦截并转发到后端排队API
location ~ ^/comfyui/([^/]+)/(\d+)/(.*)$ {
    set $comfy_port $2;
    set $api_path $3;

    proxy_pass http://192.168.150.2:$comfy_port/$api_path;
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    # WebSocket支持
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    # API不缓存
    add_header Cache-Control "no-cache, no-store";
}

# ==================== 队列脚本静态资源 ====================

# ComfyUI队列脚本（通过此路径访问）
location /static/js/comfyui-queue.js {
    alias /path/to/frontend/public/static/js/comfyui-queue.js;
    add_header Content-Type application/javascript;
    expires 1h;
}


# ==================== 使用说明 ====================

# 1. 将上述配置块添加到Nginx主配置的 server {} 块内
# 2. 修改 alias 路径指向实际的队列脚本位置
# 3. 测试配置: nginx -t
# 4. 重载配置: nginx -s reload
#
# 开发环境替代方案：
#   如果没有Nginx，可以使用前端开发服务器的代理配置
#   参考: frontend/vite.config.ts 中的 proxy 配置
